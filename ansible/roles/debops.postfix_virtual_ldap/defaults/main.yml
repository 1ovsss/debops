---
# .. vim: foldmarker=[[[,]]]:foldmethod=marker

# .. _postfix_virtual_ldap__ref_defaults:

# debops.postfix_virtual_ldap default variables [[[
# =================================================

# .. contents:: Sections
#    :local:
#
# .. include:: ../../../../includes/global.rst

# APT packages [[[
# ----------------

# .. envvar:: postfix_virtual_ldap__postfix__dependent_packages [[[
#
# List of additional APT packages needed for the LDAP support.
postfix_virtual_ldap__postfix__dependent_packages: '{{ [ "postfix-ldap" ]
                                                       if postfix_virtual_ldap__ldap_enabled else [] }}'
                                                                   # ]]]
                                                                   # ]]]
# PKI / TLS configuration [[[
# ---------------------------

# .. envvar:: postfix_virtual_ldap_tls_ca_cert_dir [[[
#
# Directory containing X509 Certification  Authority  certificates
# in  PEM  format  which  are  to  be  recognized by the client in
# SSL/TLS connections. The files each contain one CA  certificate.
postfix_virtual_ldap_tls_ca_cert_dir: '/etc/ssl/certs/'
                                                                   # ]]]
                                                                   # ]]]
# Secrets [[[
# -----------

# .. envvar:: postfix_virtual_ldap__no_log [[[
#
# This variable can be used in the Ansible tasks to set the ``no_log``
# parameter. Changing it to ``False`` can help with debugging issues with the
# roles, but otherwise it should be set to ``True`` to ensure that Ansible
# doesn't leak sensitive data in its logs.
postfix_virtual_ldap__no_log: True
                                                                   # ]]]
                                                                   # ]]]

# Virtual Mail [[[
# ----------------
#
# This settings help to configure to enable `postfix` to host multiple (virtual) domains,
# and thus provide email to several domains with just one `mail server`.
# Currently the Virtual Mail support works only with LDAP enabled, in the future `mariaDB` could be enabled.
#

# .. envvar:: postfix_virtual_ldap__vmail_posix_user [[[
#
# Virtual Mail POSIX username
# For the accesses to the mailbox directories a separate user `vmail` (`Virtual Mail`) is created,
# under which the accesses of Postfix, Dovecot and other components of the mail server should take place.
# On the one hand this prevents mail server components from accessing sensitive system directories,
# on the other hand it protects the mailboxes from external access.
# Only vmail (and root) are allowed to access the mailboxes.
postfix_virtual_ldap__vmail_posix_user: 'vmail'
                                                                   # ]]]
# .. envvar:: postfix_virtual_ldap__vmail_posix_uidnumber [[[
#
# Virtual Mail POSIX uidNumber
#
postfix_virtual_ldap__vmail_posix_uidnumber: '{{ getent_passwd[postfix_virtual_ldap__vmail_posix_user][1]|int }}'
                                                                   # ]]]
# .. envvar:: postfix_virtual_ldap__vmail_posix_group [[[
#
# Virtual Mail POSIX group
#
postfix_virtual_ldap__vmail_posix_group: 'vmail'
                                                                   # ]]]
# .. envvar:: postfix_virtual_ldap__vmail_posix_gidnumber [[[
#
# Virtual Mail POSIX gidNumber
#
postfix_virtual_ldap__vmail_posix_gidnumber: '{{ getent_group[postfix_virtual_ldap__vmail_posix_group][1]|int }}'
                                                                   # ]]]
# .. envvar:: postfix_virtual_ldap__mailbox_base [[[
#
# All mailboxes are stored directly in the file system of the server.
#
# This setting describes the prefix that the virtual delivery agent prepends to all pathname results from
# `$virtual_mailbox_maps` table lookups.
# The directories under this base contain the users MailDirs.
# This directory must be created in advance and must be writeable by all potential mail users.
# To achieve this, either use the same GID across all mail users and set group ownership to that GID,
# or make the directory world writable.
postfix_virtual_ldap__mailbox_base: '/var/vmail'
                                                                   # ]]]
# .. envvar:: postfix_virtual_ldap__virtual_alias_maps [[[
#
# Optional lookup tables that alias specific mail addresses or domains
# to other local or remote address.
# The default option, when using Virtual Mail with LDAP, will first go over the
# alisaes set by :ref:`debops.etc_aliases` and if no match is found query
# the LDAP for the email address.
#
# Specify zero or more `type:name` lookup tables, separated by whitespace or comma.
# Tables will be searched in the specified order until a match is found.
# Note: these lookups are recursive.
postfix_virtual_ldap__virtual_alias_maps:
  - '$alias_maps'
  - 'ldap:/etc/postfix/ldap_virtual_aliases.cf'
                                                                   # ]]]
                                                                   # ]]]
# Postfix 'main.cf' configuration [[[
# -----------------------------------

# These variables define the contents of the :file:`/etc/postfix/main.cf`
# configuration file. See :ref:`postfix__ref_maincf` for more details.

# .. envvar:: postfix_virtual_ldap__postfix__dependent_maincf [[[
#
# List of options needed by `postfix` for the Virtual Mail configuration
postfix_virtual_ldap__postfix__dependent_maincf:
  # Postfix is final destination for the specified list of virtual alias domains,
  # that is, domains for which all addresses are aliased to addresses in other local or remote domains
  - name: 'virtual_alias_domains'
    value: 'ldap:/etc/postfix/ldap_virtual_alias_domains.cf'
    section: 'virtual'
    state: '{{ "present"
            if (postfix_virtual_ldap__ldap_enabled|bool and
                postfix__version is version_compare("2.0", ">="))
            else "absent" }}'

  # Postfix is final destination for the specified list of domains; mail is delivered
  # via the $virtual_transport mail delivery transport
  - name: 'virtual_mailbox_domains'
    value: 'ldap:/etc/postfix/ldap_virtual_domains.cf'
    section: 'virtual'
    state: '{{ "present"
            if (postfix_virtual_ldap__ldap_enabled|bool and
                postfix__version is version_compare("2.0", ">="))
            else "absent" }}'

  # Optional lookup tables that alias specific mail addresses or domains to other local or remote address.
  - name: 'virtual_alias_maps'
    value: '{{ postfix_virtual_ldap__virtual_alias_maps | join(",") }}'
    section: 'virtual'
    state: '{{ "present"
            if (postfix_virtual_ldap__ldap_enabled|bool and
                postfix__version is version_compare("2.0", ">="))
            else "absent" }}'

  #A prefix that the virtual delivery agent prepends to all pathname results from $virtual_mailbox_maps table lookups.
  # This is a safety measure to ensure that an out of control map doesn't litter the file system with mailboxes.
  - name: 'virtual_mailbox_base'
    value: '{{ postfix_virtual_ldap__mailbox_base }}'
    section: 'virtual'
    state: '{{ "present"
            if (postfix_virtual_ldap__ldap_enabled|bool and
                postfix__version is version_compare("2.0", ">="))
            else "absent" }}'

  # Optional lookup tables with all valid addresses in the domains that match $virtual_mailbox_domains.
  - name: 'virtual_mailbox_maps'
    value: 'ldap:/etc/postfix/ldap_virtual_recipients.cf'
    section: 'virtual'
    state: '{{ "present"
            if (postfix_virtual_ldap__ldap_enabled|bool and
                postfix__version is version_compare("2.0", ">="))
            else "absent" }}'

  # Lookup tables with the per-recipient user ID that the virtual delivery agent uses while writing
  # to the recipient's mailbox.
  - name: 'virtual_uid_maps'
    value: 'static:{{ postfix_virtual_ldap__vmail_posix_uidnumber }}'
    section: 'virtual'
    state: '{{ "present"
            if (postfix_virtual_ldap__ldap_enabled|bool and
                postfix__version is version_compare("2.0", ">="))
            else "absent" }}'

  # Lookup tables with the per-recipient group ID for virtual mailbox delivery.
  - name: 'virtual_gid_maps'
    value: 'static:{{ postfix_virtual_ldap__vmail_posix_gidnumber }}'
    section: 'virtual'
    state: '{{ "present"
            if (postfix_virtual_ldap__ldap_enabled|bool and
                postfix__version is version_compare("2.0", ">="))
            else "absent" }}'

  # The minimum user ID value that the virtual delivery agent accepts as a result from $virtual_uid_maps table lookup
  # FIXME: problems while parsing number.
  - name: 'virtual_minimum_uid'
    value: '{{ postfix_virtual_ldap__vmail_posix_uidnumber }}'
    section: 'virtual'
    state: 'absent'

  # Optional lookup table with the SASL login names that own the sender (MAIL FROM) addresses.
  - name: 'smtpd_sender_login_maps'
    value: 'ldap:/etc/postfix/ldap_virtual_senders.cf'
    section: 'base'
    state: '{{ "present"
            if (postfix_virtual_ldap__ldap_enabled|bool)
            else "absent" }}'
                                                                   # ]]]
# .. envvar:: postfix_virtual_ldap__postfix_lookup_header [[[
#
# The header of the lookup table containing the settings to connect to the LDAP server
postfix_virtual_ldap__postfix_lookup_header:
  server_host: '{{ postfix_virtual_ldap__ldap_uri }}'
  start_tls: '{{ "yes"
                  if (postfix_virtual_ldap__ldap_start_tls|bool)
                  else "no" }}'
  version: '3'
  tls_ca_cert_dir: '{{ postfix_virtual_ldap_tls_ca_cert_dir }}'
  bind: 'yes'
  bind_dn: '{{ postfix_virtual_ldap__ldap_binddn }}'
  bind_pw: '{{ postfix_virtual_ldap__ldap_bindpw }}'
  scope: 'sub'
                                                                   # ]]]
# .. envvar:: postfix_virtual_ldap__postfix__lookup_virtual_aliases [[[
#
# The virtual_alias_maps setting is used to find the target mailbox
# (configured in the attribute mail, aka the mailbox or maildrop).
postfix_virtual_ldap__postfix__lookup_virtual_aliases:
  search_base: '{{ postfix_virtual_ldap__ldap_people_dn|join(",") }}'
  query_filter: '(&(mailAlias=%s){{ postfix_virtual_ldap__ldap_user_filter }})'
  result_attribute: 'mail'
                                                                   # ]]]
# .. envvar:: postfix_virtual_ldap__postfix__lookup_virtual_recipients [[[
#
# As we only want to accept mail, where we know the recipients
# (and are responsible for them), the virtual_mailbox_maps configuration is used.
postfix_virtual_ldap__postfix__lookup_virtual_recipients:
  search_base: '{{ postfix_virtual_ldap__ldap_people_dn|join(",") }}'
  query_filter: '(&(|(mail=%s)(mailAlias=%s)){{ postfix_virtual_ldap__ldap_user_filter }})'
  result_attribute: 'mail'
  result_format: '/%d/%u/mailbox/'
                                                                   # ]]]
# .. envvar:: postfix_virtual_ldap__postfix__lookup_virtual_domains [[[
#
# The virtual_mailbox_domains configurations performs a lookup,
# if the postfix is responsible for the given domain.
postfix_virtual_ldap__postfix__lookup_virtual_domains:
  search_base: '{{ postfix_virtual_ldap__ldap_domains_dn|join(",") }}'
  query_filter: '{{ postfix_virtual_ldap__ldap_domain_filter }}'
  result_attribute: 'dc'
                                                                   # ]]]
# .. envvar:: postfix_virtual_ldap__postfix__lookup_virtual_senders [[[
#
# The smtpd_sender_login_maps configurations performs a lookup from an incoming
# email-recipient to a username. Postfix first performs a full lookup
# on user@domain, then user and then @domain.
# The later one is also used for catchalls where the mailAlias
# is set to e.g. @foobar.com
postfix_virtual_ldap__postfix__lookup_virtual_senders:
  search_base: '{{ postfix_virtual_ldap__ldap_people_dn|join(",") }}'
  query_filter: '(&(mailAlias=%s){{ postfix_virtual_ldap__ldap_user_filter }})'
  result_attribute: 'uid, mail'
                                                                   # ]]]
# .. envvar:: postfix_virtual_ldap__postfix__dependent_lookup_tables [[[
#
# The Virtual Mail lookup tables for postfix
postfix_virtual_ldap__postfix__dependent_lookup_tables:

  - name: 'ldap_virtual_aliases.cf'
    state: 'present'
    comment: |
      The virtual_alias_maps setting is used to find the target mailbox
      (configured in the attribute mail, aka the mailbox or maildrop).
    group: 'postfix'
    mode: '0640'
    no_log: '{{ postfix_virtual_ldap__no_log|d(True) }}'
    config: '{{ postfix_virtual_ldap__postfix_lookup_header |
                 combine(postfix_virtual_ldap__postfix__lookup_virtual_aliases) }}'

  - name: 'ldap_virtual_recipients.cf'
    state: 'present'
    comment: |
      As we only want to accept mail, where we know the recipients
      (and are responsible for them), the virtual_mailbox_maps configuration is used.
    group: 'postfix'
    mode: '0640'
    no_log: '{{ postfix_virtual_ldap__no_log|d(True) }}'
    config: '{{ postfix_virtual_ldap__postfix_lookup_header |
                 combine(postfix_virtual_ldap__postfix__lookup_virtual_recipients) }}'

  - name: 'ldap_virtual_domains.cf'
    state: 'present'
    comment: |
      The virtual_mailbox_domains configurations performs a lookup,
      if the postfix is responsible for the given domain.
    group: 'postfix'
    mode: '0640'
    no_log: '{{ postfix_virtual_ldap__no_log|d(True) }}'
    config: '{{ postfix_virtual_ldap__postfix_lookup_header |
                 combine(postfix_virtual_ldap__postfix__lookup_virtual_domains) }}'

  - name: 'ldap_virtual_senders.cf'
    state: 'present'
    comment: |
      The smtpd_sender_login_maps configurations performs a lookup from an incoming
      email-recipient to a username. Postfix first performs a full lookup
      on user@domain, then user and then @domain.
      The later one is also used for catchalls where the mailAlias
      is set to e.g. @foobar.com
    group: 'postfix'
    mode: '0640'
    no_log: '{{ postfix_virtual_ldap__no_log|d(True) }}'
    config: '{{ postfix_virtual_ldap__postfix_lookup_header |
                 combine(postfix_virtual_ldap__postfix__lookup_virtual_senders) }}'

                                                                   # ]]]
                                                                   # ]]]
# LDAP [[[
# --------

# LDAP authentication [[[
# ^^^^^^^^^^^^^^^^^^^^^^

# .. envvar:: postfix_virtual_ldap__ldap_enabled [[[
#
# In order to enable Virtual Mail support LDAP authentication needs to be enabled.
# When enabled, `postfix` will configure mail-boxes locally and allow LDAP authenticated users to
# send email over this instance.
postfix_virtual_ldap__ldap_enabled: '{{ True
                                       if (ansible_local|d() and ansible_local.ldap|d() and
                                          (ansible_local.ldap.enabled|d())|bool)
                                       else False }}'
                                                                   # ]]]
# .. envvar:: postfix_virtual_ldap__ldap_base_dn [[[
#
# The base Distinguished Name which should be used to create Distinguished
# Names of the LDAP directory objects, defined as a YAML list. If this variable
# is empty, automated Postfix LDAP configuration will not be performed.
postfix_virtual_ldap__ldap_base_dn: '{{ ansible_local.ldap.base_dn
                                        if (ansible_local|d() and ansible_local.ldap|d() and
                                            ansible_local.ldap.base_dn|d())
                                        else [] }}'

                                                                   # ]]]
# .. envvar:: postfix_virtual_ldap__ldap_device_dn [[[
#
# The Distinguished Name of the current host LDAP object, defined as a YAML
# list. It will be used as a base for the Postfix service account LDAP
# object. If the list is empty, the role will not create the account LDAP
# object automatically.
postfix_virtual_ldap__ldap_device_dn: '{{ ansible_local.ldap.device_dn
                                          if (ansible_local|d() and ansible_local.ldap|d() and
                                              ansible_local.ldap.device_dn|d())
                                          else [] }}'

                                                                   # ]]]
# .. envvar:: postfix_virtual_ldap__ldap_self_rdn [[[
#
# The Relative Distinguished Name of the account LDAP object used by the
# Postfix service to access the LDAP directory.
postfix_virtual_ldap__ldap_self_rdn: 'uid=postfix'

                                                                   # ]]]
# .. envvar:: postfix_virtual_ldap__ldap_self_object_classes [[[
#
# List of the LDAP object classes which will be used to create the LDAP object
# used by the `postfix` service to access the LDAP directory.
postfix_virtual_ldap__ldap_self_object_classes: [ 'account', 'simpleSecurityObject' ]

                                                                   # ]]]
# .. envvar:: postfix_virtual_ldap__ldap_self_attributes [[[
#
# YAML dictionary that defines the attributes of the LDAP object used by the
# Postfix service to access the LDAP directory.
postfix_virtual_ldap__ldap_self_attributes:
  uid: '{{ postfix_virtual_ldap__ldap_self_rdn.split("=")[1] }}'
  userPassword: '{{ postfix_virtual_ldap__ldap_bindpw }}'
  host: '{{ [ ansible_fqdn, ansible_hostname ] | unique }}'
  description: 'Account used by the "Postfix" service to access the LDAP directory'

                                                                   # ]]]
# .. envvar:: postfix_virtual_ldap__ldap_binddn [[[
#
# The Distinguished Name of the account LDAP object used by the
# Postfix service to bind to the LDAP directory.
postfix_virtual_ldap__ldap_binddn: '{{ ([ postfix_virtual_ldap__ldap_self_rdn ]
                                        + postfix_virtual_ldap__ldap_device_dn) | join(",") }}'

                                                                   # ]]]
# .. envvar:: postfix_virtual_ldap__ldap_bindpw [[[
#
# The password stored in the account LDAP object used by the Postfix service
# to bind to the LDAP directory.
postfix_virtual_ldap__ldap_bindpw: '{{ lookup("password", secret + "/ldap/credentials/"
                                  + postfix_virtual_ldap__ldap_binddn | to_uuid + ".password length=32 "
                                  + "chars=alpha,digits,!@_#$%^&*") }}'

                                                                   # ]]]
# .. envvar:: postfix_virtual_ldap__ldap_people_rdn [[[
#
# The Relative Distinguished Name of the LDAP object which contains the user
# accounts stored in LDAP.
postfix_virtual_ldap__ldap_people_rdn: '{{ ansible_local.ldap.people_rdn
                               if (ansible_local|d() and ansible_local.ldap|d() and
                                   ansible_local.ldap.people_rdn|d())
                               else "ou=People" }}'

                                                                   # ]]]
# .. envvar:: postfix_virtual_ldap__ldap_people_dn [[[
#
# The Distinguished Name of the LDAP object which contains the user accounts
# used by Postfix.
postfix_virtual_ldap__ldap_people_dn: '{{ [ postfix_virtual_ldap__ldap_people_rdn ]
                                          + postfix_virtual_ldap__ldap_base_dn }}'

                                                                   # ]]]
# .. envvar:: postfix_virtual_ldap__ldap_uri [[[
#
# List of LDAP URIs that point to the directory servers which should be used by
# nextcloudFIXME.
postfix_virtual_ldap__ldap_uri: '{{ (ansible_local.ldap.uri
                                    if (ansible_local|d() and ansible_local.ldap|d() and
                                        ansible_local.ldap.uri|d())
                                    else [""]) | first }}'

                                                                   # ]]]
# .. envvar:: postfix_virtual_ldap__ldap_private_groups [[[
#
# When this variable is enabled, the :ref:`debops.ldap` role will create
# a separate LDAP objects that manage the Postfix groups as subtree of the
# DokiWiki service LDAP object. If you set this parameter to ``False``, the
# role will use the global ``ou=Groups,dc=example,dc=org`` subtree instead.
postfix_virtual_ldap__ldap_private_groups: True

                                                                   # ]]]
# .. envvar:: postfix_virtual_ldap__ldap_groups_rdn [[[
#
# The Relative Distinguished Name of the LDAP object which contains the groups
# stored in LDAP.
postfix_virtual_ldap__ldap_groups_rdn: '{{ ansible_local.ldap.groups_rdn
                                           if (ansible_local|d() and ansible_local.ldap|d() and
                                               ansible_local.ldap.groups_rdn|d())
                                           else "ou=Groups" }}'

                                                                   # ]]]
# .. envvar:: postfix_virtual_ldap__ldap_domains_rdn [[[
#
# The Relative Distinguished Name of the LDAP object which contains the (virtual mail)
# domains stored in LDAP.
postfix_virtual_ldap__ldap_domains_rdn: '{{ ansible_local.ldap.domains_rdn
                                            if (ansible_local|d() and ansible_local.ldap|d() and
                                                ansible_local.ldap.domains_rdn|d())
                                            else "ou=Domains" }}'

                                                                   # ]]]
# .. envvar:: postfix_virtual_ldap__ldap_groups_dn [[[
#
# The Distinguished Name of the LDAP object which contains the groups used by
# Postfix. If private groups are enabled, this object will be created
# automatically.
postfix_virtual_ldap__ldap_groups_dn: '{{ ([ postfix_virtual_ldap__ldap_groups_rdn, postfix_virtual_ldap__ldap_self_rdn ]
                                           + postfix_virtual_ldap__ldap_device_dn)
                                            if postfix_virtual_ldap__ldap_private_groups|bool
                                            else ([ postfix_virtual_ldap__ldap_groups_rdn ]
                                                  + postfix_virtual_ldap__ldap_base_dn) }}'

                                                                   # ]]]
# .. envvar:: postfix_virtual_ldap__ldap_domains_dn [[[
#
# The Distinguished Name of the LDAP object which contains the (virtual mail) domains used by
# Postfix. If private groups are enabled, this object will be created
# automatically.
postfix_virtual_ldap__ldap_domains_dn: '{{ ([ postfix_virtual_ldap__ldap_domains_rdn, postfix_virtual_ldap__ldap_self_rdn ]
                                            + postfix_virtual_ldap__ldap_device_dn)
                                              if postfix_virtual_ldap__ldap_private_groups|bool
                                              else ([ postfix_virtual_ldap__ldap_domains_rdn ]
                                                    + postfix_virtual_ldap__ldap_base_dn) }}'
                                                                   # ]]]
# .. envvar:: postfix_virtual_ldap__ldap_default_virtual_domain_rdn [[[
#
# The rdn of the default virtual mail domain used by Postfix.
# This is usually the same domain used by the LDAP.
postfix_virtual_ldap__ldap_default_virtual_domain_rdn: '{{ ansible_domain }}'
                                                                   # ]]]
# .. envvar:: postfix_virtual_ldap__ldap_default_virtual_domain_dn [[[
#
# The dn of the default virtual mail domain used by Postfix.
postfix_virtual_ldap__ldap_default_virtual_domain_dn: '{{ (["dc="
                                                           + postfix_virtual_ldap__ldap_default_virtual_domain_rdn]
                                                           + postfix_virtual_ldap__ldap_domains_dn) | join(",") }}'
                                                                   # ]]]
                                                                   # ]]]
# LDAP connection options [[[
# ^^^^^^^^^^^^^^^^^^^^^^^^^^^

# .. envvar:: postfix_virtual_ldap__ldap_server_uri [[[
#
# The URI address of the LDAP server used by Postfix.
postfix_virtual_ldap__ldap_server_uri: '{{ (ansible_local.ldap.uri
                                            if (ansible_local|d() and ansible_local.ldap|d() and
                                                ansible_local.ldap.uri|d())
                                            else [""]) | first }}'

                                                                   # ]]]
# .. envvar:: postfix_virtual_ldap__ldap_server_port [[[
#
# The TCP port which should be used for connections to the LDAP server.
postfix_virtual_ldap__ldap_server_port: '{{ ansible_local.ldap.port
                                            if (ansible_local|d() and ansible_local.ldap|d() and
                                                ansible_local.ldap.port|d())
                                            else ("389" if postfix_virtual_ldap__ldap_start_tls|bool else "636") }}'

                                                                   # ]]]
# .. envvar:: postfix_virtual_ldap__ldap_start_tls [[[
#
# If ``True``, Postfix will use STARTTLS extension to make encrypted
# connections to the LDAP server.
postfix_virtual_ldap__ldap_start_tls: '{{ ansible_local.ldap.start_tls
                                          if (ansible_local|d() and ansible_local.ldap|d() and
                                              (ansible_local.ldap.start_tls|d())|bool)
                                          else True }}'

                                                                   # ]]]
                                                                   # ]]]
# LDAP settings [[[
# ^^^^^^^^^^^^^^^^^

# .. envvar:: postfix_virtual_ldap__ldap_user_filter [[[
#
# The LDAP filter used to look up user accounts in the directory.
postfix_virtual_ldap__ldap_user_filter: '(&
                                           (objectClass=inetOrgPerson)
                                           (objectClass=postfixUser)
                                         )
                                         (mailEnabled=TRUE)
                                         (|
                                           (authorizedService=postfix)
                                           (authorizedService=mail)
                                           (authorizedService=\*)
                                         )'

                                                                   # ]]]
# .. envvar:: postfix_virtual_ldap__ldap_domain_filter [[[
#
# The LDAP filter used to look up user accounts in the directory.
postfix_virtual_ldap__ldap_domain_filter: '(&
                                            (ObjectClass=dNSDomain)
                                            (dc=%s)
                                           )'

                                                                   # ]]]
# .. envvar:: postfix_virtual_ldap__ldap_quota_attribute [[[
#
# Set the LDAP attribute value to be read by Postfix in order to get the user quota.
postfix_virtual_ldap__ldap_quota_attribute: 'mailQuota'
                                                                   # ]]]
# .. envvar:: postfix_virtual_ldap__ldap_quota_default [[[
#
# User default LDAP quota. Use human-readable values, e.g. "2 GB".
postfix_virtual_ldap__ldap_quota_default: '10 GB'
                                                                   # ]]]
# .. envvar:: postfix_virtual_ldap__ldap_default_config [[[
#
# The LDAP configuration options defined by default.
postfix_virtual_ldap__ldap_default_config: []

                                                                   # ]]]
# .. envvar:: postfix_virtual_ldap__ldap_config [[[
#
# List of custom LDAP configuration options defined for all hosts
# in the Ansible inventory.
postfix_virtual_ldap__ldap_config: []
                                                                   # ]]]

# .. envvar:: postfix_virtual_ldap__group_ldap_config [[[
#
# List of custom LDAP configuration options defined on hosts in
# a specific Ansible inventory group.
postfix_virtual_ldap__group_ldap_config: []
                                                                   # ]]]

# .. envvar:: postfix_virtual_ldap__host_ldap_config [[[
#
# List of custom LDAP configuration options defined on specific
# hosts in the Ansible inventory.
postfix_virtual_ldap__host_ldap_config: []
                                                                   # ]]]

# .. envvar:: postfix_virtual_ldap__ldap_combined_config [[[
#
# The variable that combines default and user LDAP configuration and is used in
# the role tasks and templates.
postfix_virtual_ldap__ldap_combined_config: '{{ postfix_virtual_ldap__ldap_default_config
                                              + postfix_virtual_ldap__ldap_config
                                              + postfix_virtual_ldap__group_ldap_config
                                              + postfix_virtual_ldap__host_ldap_config }}'
                                                                   # ]]]
# .. envvar:: postfix_virtual_ldap__ldap__dependent_tasks [[[
#
# Configuration for the :ref:`debops.ldap` Ansible role.
postfix_virtual_ldap__ldap__dependent_tasks:
  - name: 'Create Postfix account for {{ postfix_virtual_ldap__ldap_device_dn | join(",") }}'
    dn: '{{ postfix_virtual_ldap__ldap_binddn }}'
    objectClass: '{{ postfix_virtual_ldap__ldap_self_object_classes }}'
    attributes: '{{ postfix_virtual_ldap__ldap_self_attributes }}'
    no_log: '{{ postfix_virtual_ldap__no_log|d(True) }}'
    state: '{{ "present"
                if (postfix_virtual_ldap__ldap_enabled|bool and
                    postfix_virtual_ldap__ldap_device_dn|d())
                else "ignore" }}'

  - name: 'Create Postfix group container for {{ postfix_virtual_ldap__ldap_device_dn | join(",") }}'
    dn: '{{ postfix_virtual_ldap__ldap_groups_dn }}'
    objectClass: 'organizationalUnit'
    attributes:
      ou: '{{ postfix_virtual_ldap__ldap_groups_rdn.split("=")[1] }}'
      description: 'User groups used in Postfix'
    state: '{{ "present"
               if (postfix_virtual_ldap__ldap_enabled|bool and
                   postfix_virtual_ldap__ldap_device_dn|d() and
                   postfix_virtual_ldap__ldap_private_groups|bool)
               else "ignore" }}'

  - name: 'Create Postfix domains container for {{ postfix_virtual_ldap__ldap_device_dn | join(",") }}'
    dn: '{{ postfix_virtual_ldap__ldap_domains_dn }}'
    objectClass: 'organizationalUnit'
    attributes:
      ou: '{{ postfix_virtual_ldap__ldap_domains_rdn.split("=")[1] }}'
      description: 'Virtual Mail Domains used in Postfix'
    state: '{{ "present"
               if (postfix_virtual_ldap__ldap_enabled|bool and
                   postfix_virtual_ldap__ldap_device_dn|d() and
                   postfix_virtual_ldap__ldap_private_groups|bool)
               else "ignore" }}'

  - name: 'Create Postfix Default Virtual Mail Domain for {{ postfix_virtual_ldap__ldap_default_virtual_domain_dn }}'
    dn: '{{ postfix_virtual_ldap__ldap_default_virtual_domain_dn }}'
    objectClass: 'dNSDomain'
    state: '{{ "present"
               if (postfix_virtual_ldap__ldap_enabled|bool and
                   postfix_virtual_ldap__ldap_device_dn|d() and
                   postfix_virtual_ldap__ldap_private_groups|bool)
               else "ignore" }}'
                                                                   # ]]]
                                                                   # ]]]
                                                                   # ]]]
                                                                   # ]]]
